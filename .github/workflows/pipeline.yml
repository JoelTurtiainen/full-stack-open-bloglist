on:
  push:
    branches: 
    - main
  pull_request: 
    branches: [main]
    types: [opened, synchronize]

# permissions:
#   contents: read
#   pages: write
#   id-token: write

env:
  SKIP: ${{ contains(toJson(github.event.head_commit.message), '#skip') && github.event_name == 'push'}}
  AUTHOR: ${{github.event.head_commit.author.username}}
  COMMIT_URL: ${{toJson(github.event.head_commit.url)}}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Git checkout
      uses: actions/checkout@v5

    - name: create .env file for backend
      run: echo -e "TEST_MONGODB_URI=${{secrets.TEST_MONGODB_URI}}\nPORT=${{secrets.PORT}}\nSECRET=${{secrets.SECRET}}" > .env

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20 
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Wait for Render Deployment
      if: env.SKIP == 'false'
      uses: JorgeLNJunior/render-deploy@v1.4.5
      with:
        service_id: ${{ secrets.RENDER_SERVICE_ID }}
        api_key: ${{ secrets.RENDER_API_KEY }}

  tag_release:
    needs: [deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'

    - name: Bump version and push tag
      if: env.SKIP == 'false'
      uses: anothrNick/github-tag-action@1.75.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DEFAULT_BUMP: patch

  failure:
    needs: [deploy, tag_release]
    if: failure() 
    runs-on: ubuntu-latest
    steps:
    - name: Send discord message about failure
      uses: rjstone/discord-webhook-notify@v2
      with:
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
        username: GitHub 
        avatarUrl: https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png
        text: Build failed 
        severity: error
        color: '#9a0800'
        description: "commit ${{ env.COMMIT_URL }} by ${{ env.AUTHOR }} broke the build :("

  success:
    needs: [deploy, tag_release]
    if: success() 
    runs-on: ubuntu-latest
    steps:
    - name: Send discord message about success
      uses: rjstone/discord-webhook-notify@v2
      with:
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
        username: GitHub 
        avatarUrl: https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png
        text: A new version of Bloglist deployed
        severity: info
        color: '#049a00'
        description: "to ${{ env.DEPLOY_URL }} by ${{env.AUTHOR}}"
